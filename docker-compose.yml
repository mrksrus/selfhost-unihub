# ── Shared database credentials (change before first launch) ──────
x-db-credentials: &db_credentials
  MYSQL_DATABASE: unihub
  MYSQL_USER: unihub
  MYSQL_PASSWORD: changeme_user_password          # ← CHANGE THIS

services:
  # ── UniHub Application (Frontend + API) ─────────────────────────
  #
  # Default admin account (created automatically on first start):
  #   Email:    admin@unihub.local
  #   Password: admin123
  #
  # ⚠  Change the admin password immediately after first login:
  #    Settings → Security → Change Password
  #
  unihub:
    image: ghcr.io/mrksrus/unify-self-host:latest
    build: .                          # Remove this line on TrueNAS / when using pre-built images
    container_name: unihub
    restart: unless-stopped
    ports:
      - "3000:80"
    environment:
      NODE_ENV: production
      <<: *db_credentials
      MYSQL_HOST: unihub-mysql
      MYSQL_PORT: "3306"
      # ── Required: set a strong, random secret ──────────────────────
      # Generate one with:  openssl rand -base64 48
      JWT_SECRET: ""                               # ← REQUIRED – fill this in
      # ── Encryption key for stored email passwords ──────────────────
      ENCRYPTION_KEY: changeme_encryption_key      # ← CHANGE THIS
    depends_on:
      unihub-mysql:
        condition: service_healthy
    networks:
      - unihub-network
    volumes:
      - uploads_data:/app/uploads

  # ── MySQL Database ──────────────────────────────────────────────
  unihub-mysql:
    image: mysql:8.0
    container_name: unihub-mysql
    restart: unless-stopped
    environment:
      <<: *db_credentials
      MYSQL_ROOT_PASSWORD: changeme_root_password  # ← CHANGE THIS
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=100
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - unihub-network

networks:
  unihub-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  uploads_data:
    driver: local
