version: '3.8'

x-db-credentials: &db_credentials
  # ── Database credentials (single source of truth) ──────────────────
  # Change these before first launch.
  MYSQL_DATABASE: unihub
  MYSQL_USER: unihub
  MYSQL_PASSWORD: unihub_password_secure_123
  MYSQL_ROOT_PASSWORD: unihub_root_password_secure_123

services:
  # ── UniHub Web Application ─────────────────────────────────────────
  unihub-app:
    image: ghcr.io/mrksrus/unify-self-host-app:latest
    container_name: unihub-app
    restart: unless-stopped
    ports:
      # Host port → container port.  Change the left side only.
      - "3000:80"
    depends_on:
      unihub-api:
        condition: service_healthy
    networks:
      - unihub-network
    volumes:
      - ./data/uploads:/app/uploads

  # ── MySQL Database ─────────────────────────────────────────────────
  unihub-mysql:
    image: mysql:8.0
    container_name: unihub-mysql
    restart: unless-stopped
    environment:
      <<: *db_credentials
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
      - ./docker/mysql/conf:/etc/mysql/conf.d:ro
    #
    # Default admin account (created on first start by the DB seed):
    #   Email:    admin@unihub.local
    #   Password: admin123
    #
    # ⚠  Change the admin password after first login:
    #    Settings → Security → Change Password
    #
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - unihub-network

  # ── Backend API (internal only – not exposed to host) ──────────────
  unihub-api:
    image: ghcr.io/mrksrus/unify-self-host-api:latest
    container_name: unihub-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      <<: *db_credentials
      MYSQL_HOST: unihub-mysql
      MYSQL_PORT: "3306"
      # ── Required: set a strong, random JWT secret ──────────────────
      # Generate one with:  openssl rand -base64 48
      JWT_SECRET: ""
      # ── Encryption key for stored email passwords ──────────────────
      # Change this to a random string before first launch.
      ENCRYPTION_KEY: unihub_encryption_key_change_me
    depends_on:
      unihub-mysql:
        condition: service_healthy
    networks:
      - unihub-network

networks:
  unihub-network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
